# WebDAV 同步功能使用说明

## 功能概述

WebDAV 同步功能可以将你的 WireGuard 配置（服务端配置和历史记录）同步到云端，实现多设备之间的配置共享。

## 如何使用

### 1. 打开 WebDAV 设置

在主界面左侧侧边栏，点击 **☁️ WebDAV 同步** 按钮进入设置页面。

### 2. 配置 WebDAV 服务器

#### 基本设置

1. **启用 WebDAV 同步**：勾选复选框以启用功能
2. **服务器地址**：填写你的 WebDAV 服务器地址
   - 示例：`https://dav.example.com/remote.php/dav/files/username/`
3. **用户名**：WebDAV 账号用户名
4. **密码**：WebDAV 账号密码
5. **自动同步间隔**：设置自动同步的时间间隔（秒），最少 60 秒，默认 300 秒（5 分钟）

#### 安全提示

⚠️ **重要**：密码将以明文形式存储在本地配置文件中，请务必使用 HTTPS 协议连接 WebDAV 服务器以确保安全。

### 3. 测试连接

配置完成后，点击 **测试连接** 按钮验证服务器连接是否正常。

如果连接成功，会显示 ✓ 连接成功！

### 4. 保存配置

点击 **保存配置** 按钮保存你的 WebDAV 设置。

### 5. 同步数据

#### 同步方式

应用提供了三种同步方式：

1. **双向智能同步**（推荐）
   - 自动比较本地和远程文件的时间戳
   - 上传较新的本地文件
   - 下载较新的远程文件
   - 适合多设备使用场景

2. **仅上传到云端**
   - 将所有本地配置和历史记录上传到 WebDAV 服务器
   - 不会下载远程文件
   - 适合备份场景

3. **仅从云端下载**
   - 从 WebDAV 服务器下载所有配置和历史记录
   - 不会上传本地文件
   - 适合恢复数据或在新设备上使用

#### 手动同步

点击对应的同步按钮即可手动触发同步。

同步完成后会显示详细的同步结果：
- 上传/下载的服务端配置数量
- 上传/下载的历史记录数量

#### 自动同步

勾选 **启用自动同步** 复选框，应用将按照设定的时间间隔自动执行双向智能同步。

上次同步时间会实时显示在同步控制区域。

## 同步的数据

WebDAV 同步功能会同步以下数据：

- **服务端配置** (`servers/` 目录)
  - 所有服务端的配置信息
  - 包括服务端公钥、Endpoint、预共享密钥等

- **历史记录** (`history/` 目录)
  - 所有生成过的客户端配置历史
  - 包括完整的配置内容和元数据

## 远程目录结构

在 WebDAV 服务器上，数据将存储在以下目录结构中：

```
<你配置的服务器地址>/
├── servers/           # 服务端配置
│   ├── server1.json
│   └── server2.json
└── history/          # 历史记录
    ├── 123456.json
    └── 789012.json
```

例如，如果你配置的服务器地址是 `http://10.0.0.88:5005/file/wireguard`，那么实际的目录结构将是：
- 服务端配置：`http://10.0.0.88:5005/file/wireguard/servers/`
- 历史记录：`http://10.0.0.88:5005/file/wireguard/history/`

## 兼容的 WebDAV 服务

应用支持所有标准的 WebDAV 服务，包括但不限于：

### 自建服务
- **Nextcloud** / **ownCloud**
- **群晖 NAS** (Synology)
- **威联通 NAS** (QNAP)
- Apache / Nginx 配置的 WebDAV 服务

### 云服务
- **坚果云**（推荐，国内访问稳定）
- **阿里云盘**（需使用第三方 WebDAV 工具）
- 其他支持 WebDAV 的云存储服务

## 常见 WebDAV 服务器地址格式

### Nextcloud
```
https://your-nextcloud.com/remote.php/dav/files/username/
```

### 坚果云
```
https://dav.jianguoyun.com/dav/
```

### 群晖 NAS
```
https://your-nas-ip:5006/
```

### 威联通 NAS
```
https://your-qnap-ip/dav/
```

## 故障排查

### 连接失败

1. **检查服务器地址**：确保 URL 格式正确，以 `/` 结尾
2. **检查用户名和密码**：确认登录凭据正确
3. **检查网络连接**：确保可以访问 WebDAV 服务器
4. **检查 HTTPS 证书**：如果是自签名证书，可能需要额外配置

### 同步失败

1. **检查磁盘空间**：确保服务器有足够的存储空间
2. **检查权限**：确保 WebDAV 账号有读写权限
3. **查看错误信息**：根据提示的错误信息进行相应处理

## 数据安全建议

1. **使用 HTTPS**：始终使用 HTTPS 协议连接 WebDAV 服务器
2. **强密码**：为 WebDAV 账号设置强密码
3. **独立账号**：建议为此应用创建独立的 WebDAV 账号
4. **定期备份**：虽然有云同步，建议定期导出配置进行本地备份
5. **私有服务器**：有条件的话，使用自建的 WebDAV 服务器

## 技术细节

- **认证方式**：HTTP Basic Authentication
- **传输协议**：HTTPS (推荐) 或 HTTP
- **冲突处理**：基于文件时间戳，较新的文件会覆盖较旧的文件
- **自动同步**：基于定时器，最小间隔 60 秒

## 配置文件位置

WebDAV 配置保存在应用数据目录下的 `webdav.json` 文件中。

- **macOS**: `~/Library/Application Support/com.wireguard.generator/webdav.json`
- **Windows**: `%APPDATA%\com.wireguard.generator\webdav.json`
- **Linux**: `~/.config/com.wireguard.generator/webdav.json`

## 注意事项

1. 密码以明文存储，请注意安全
2. 自动同步会在后台运行，请确保网络连接稳定
3. 同步过程中不要关闭应用
4. 多设备同时编辑同一配置时，以最后保存的为准
5. 删除本地配置后，同步不会自动删除远程文件

## 反馈和支持

如果在使用过程中遇到问题，请在 GitHub 提交 Issue：
https://github.com/mrtian2016/wireguard-config-generator/issues
